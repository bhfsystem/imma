#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"
  source normalize

  local pth_base="$shome/org/${CONTEXT_ORG}"
  local pth_context=

  while [[ "$#" -gt 0 ]]; do
    if [[ -d "$pth_base/$pth_context/$1" ]]; then
      pth_context="${pth_context:+${pth_context}/}$1"
      shift
    else
      break
    fi
  done

  if [[ -n "$pth_context" ]]; then
    cd "$pth_base/$pth_context"
  else
    pth_context="${PWD#*/org/*/}"
  fi

  export FOGG_PREFIX="${pth_context//\//-}"
    
  local nm_region="$(cat .terraform/terraform.tfstate 2>/dev/null | jq -r '.modules[0].outputs.aws_region.value//""')"
  if [[ -z "$nm_region" ]]; then
    nm_region="$(hcltool terraform.tfvars 2>/dev/null | jq -r '.aws_region')"
  fi

  if [[ -z "$nm_region" ]]; then
    echo "ERROR: can't find region in parent tfstate or current tfvars" 1>&2
    return 1
  fi

  aws "$nm_region" exec fogg "$@"
}

export CONTEXT_ORG="${PWD##*/org/}"
export CONTEXT_ORG="${CONTEXT_ORG%%/*}"
[[ -z "${AWS_DEFAULT_REGION:-}" ]] && source aws-eu-west-1

_shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
source "$_shome/script/profile"

switch_role "${CONTEXT_ORG//-/_}"

source sub-chain imma "$@"
