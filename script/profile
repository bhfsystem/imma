#!/usr/bin/env bash

function _imma_profile {
  local shome="${_imma_home:-"$(cd -P -- "$(dirname -- "$BASH_SOURCE")/.." && pwd -P)"}"
  PATH="$shome/bin:$shome/exec:$PATH"
}

function switch_role {
  local nm_role="$1"; shift

  local a
  for a in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_DEFAULT_REGION; do
    local b="${CONTEXT_ORG}_${nm_role}_$a"
    export "$a"="${!b}"
  done
}

function _imma {
	case "${1:-}" in
    assume)
      shift # 'assume'
      local nm_role

      if [[ -n "${1:-}" ]]; then
        nm_role="$1"; shift
      else
        nm_role="administrator"
      fi

      eval $(command imma role "$nm_role")
      switch_role "$nm_role"
      ;;
    *)
      command "${FUNCNAME[1]}" "$@"
      ;;
  esac
}

_imma_profile
