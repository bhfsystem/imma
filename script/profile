#!/usr/bin/env bash

function _imma_profile {
  local shome="${_imma_home:-"$(cd -P -- "$(dirname -- "$BASH_SOURCE")/.." && pwd -P)"}"
  PATH="$shome/bin:$shome/exec:$PATH"
}

function switch_role {
  local nm_org_prefix="$1"; shift

  local a
  for a in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_DEFAULT_REGION; do
    local b="${nm_org_prefix}_$a"
    export "$a"="${!b}"
  done
}

function _imma {
	case "${1:-}" in
		switch)
      shift
      local nm_org

      if [[ -n "${1:-}" ]]; then
        nm_org="$1"; shift
      else
        nm_org="${FUNCNAME[1]}"
      fi

      switch_role "$nm_org"

      if [[ "$#" -gt 0 ]]; then
        exec "$@"
      fi
      ;;
    role)
      shift
      local nm_role

      if [[ -n "${1:-}" ]]; then
        nm_role="$1"; shift
      else
        nm_role="administrator"
      fi

      local nm_org="${FUNCNAME[1]}"

      eval $(command "${FUNCNAME[1]}" role "$nm_role")
      switch_role "$nm_org"
      ;;
    *)
      command "${FUNCNAME[1]}" "$@"
      ;;
  esac
}

function immanent {
  _imma "$@"
}

function imma {
  _imma "$@"
}

_imma_profile
