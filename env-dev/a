rel := ..

env-links:

	ln -nfs $(rel)/common/Makefile .
	imma gen env > _fogg.tf.json.1
	cat _fogg.tf.json.1 | jq -r '.module | map(.source)[]' | sort -u | (cat $(rel)/module/export.json; runmany 'cat $$1/export.json'; runmany 'hcltool $(rel)/common/$$1.tf' global) | jq -s 'reduce .[] as $$exp ({}; . * $$exp)' > _fogg.tf.json.2
	jq -n --argfile app _fogg.tf.json.1 --argfile fogg _fogg.tf.json.2 '$$app * $$fogg' > _fogg.tf.json.3
	cat _fogg.tf.json.3 | jq '.variable.global_remote_state |= { default: "$(rel)/global/.terraform/terraform.tfstate" }' > _fogg.tf.json.4
	cat _fogg.tf.json.4 | jq --arg env_name $(shell echo $(PWD) | cut -d- -f2-) '.variable.env_name |= { default: $$env_name }' > _fogg.tf.json.5
  
  mv _fogg.tf.json.5 _fogg.tf.json
	rm -f _fogg.tf.json.*
